# Keycloak Production Configuration
# This file contains build-time and runtime configuration for Keycloak
# Values prefixed with % are resolved from environment variables

# ====================
# Database Configuration
# ====================
db=postgres
db-url-host=keycloak_db
db-url-port=5432
db-url-database=keycloak
db-schema=public

# Database pool tuning
# Set max lifetime to 27000 seconds (7.5 hours) to be less than PostgreSQL default wait_timeout (8 hours)
db-pool-max-size=20
db-pool-initial-size=5
db-pool-min-size=5
db-pool-max-lifetime=27000

# ====================
# Hostname Configuration
# ====================
hostname=localhost
hostname-strict=true
hostname-strict-backchannel=true

# ====================
# HTTP/HTTPS Configuration
# ====================
http-enabled=false
https-port=8443

# ====================
# Health and Metrics
# ====================
health-enabled=true
metrics-enabled=true

# ====================
# Logging
# ====================
log-level=INFO
log-console-output=default

# ====================
# Clustering and High Availability
# ====================
# Database lock timeout for cluster boot synchronization (in seconds)
# Prevents conflicts when multiple nodes boot concurrently
spi-dblock-jpa-lock-wait-timeout=900

# ====================
# Performance and Load Management
# ====================
# Limit queued HTTP requests to prevent overload
http-max-queued-requests=200

# ====================
# Database Migration (JPA / Hibernate) - Production settings
# ====================
spi-connections-jpa--quarkus--migration-strategy=manual
# When set to false, Keycloak will not initialize an empty database schema
# automatically. This is useful to avoid accidental schema creation.
spi-connections-jpa--quarkus--initialize-empty=false

# Optional: export SQL migration to a file when running migrations (uncomment to use)
# spi-connections-jpa--quarkus--migration-export=/opt/keycloak/data/migration.sql

# ====================
# Proxy Configuration
# ====================
# Enable when running behind a reverse proxy
proxy-address-forwarding=true
