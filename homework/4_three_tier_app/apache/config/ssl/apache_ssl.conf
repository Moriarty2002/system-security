# generated 2025-11-04, Mozilla Guideline v5.7, Apache 2.4.60, OpenSSL 3.4.0, modern config
# https://ssl-config.mozilla.org/#server=apache&version=2.4.60&config=modern&openssl=3.4.0&guideline=5.7

# this configuration requires mod_ssl, mod_rewrite, mod_headers to be enabled

# redirect HTTP to HTTPS
<VirtualHost *:80>
    RewriteEngine On
    RewriteCond %{REQUEST_URI} !^/.well-known/acme-challenge/
    RewriteRule ^.*$ https://%{HTTP_HOST}%{REQUEST_URI} [R=301,QSA,L]
</VirtualHost>


# Listen on port 443 for HTTPS
Listen 443

<VirtualHost *:443>
    ServerName localhost
    
    # This points to the default Apache web root
    DocumentRoot "/usr/local/apache2/htdocs"
    
    SSLEngine on
    SSLCertificateFile    "/usr/local/apache2/conf/extra/certs/user_certificate_signed.pem"
    SSLCertificateKeyFile "/usr/local/apache2/conf/extra/certs/user_priv_key.pem"
    
    # Enable HTTP/2 when available
    Protocols h2 http/1.1

    # HTTP Strict Transport Security (mod_headers is required) (2 years)
    Header always set Strict-Transport-Security "max-age=63072000"    

    # NIST 800-53 SC-18: Mobile Code Security Controls
    # Content Security Policy - Restricts mobile code execution sources
    Header always set Content-Security-Policy "default-src 'self'; script-src 'self' https://shared-keycloak-server:8443 https://localhost:8443 'unsafe-inline'; style-src 'self' https://unpkg.com 'unsafe-inline'; img-src 'self' data:; font-src 'self' data:; connect-src 'self' https://shared-keycloak-server:8443 https://localhost:8443; frame-src 'self' https://shared-keycloak-server:8443 https://localhost:8443; frame-ancestors 'self' https://shared-keycloak-server:8443 https://localhost:8443; base-uri 'self'; form-action 'self'"
    
    # Prevent MIME-sniffing attacks that could execute unexpected code
    Header always set X-Content-Type-Options "nosniff"
    
    # Prevent clickjacking by disallowing iframe embedding
    Header always set X-Frame-Options "DENY"
    
    # Enable XSS protection in older browsers
    Header always set X-XSS-Protection "1; mode=block"
    
    # Control information sent in Referer header
    Header always set Referrer-Policy "strict-origin-when-cross-origin"
    
    # Disable client-side caching of sensitive responses
    Header always set Cache-Control "no-store, no-cache, must-revalidate, private"
    Header always set Pragma "no-cache"
    Header always set Expires "0"

    # Reverse Proxy, all requests to /api/ are sent to the backend service
    ProxyPass        /api/ http://backend:5000/
    ProxyPassReverse /api/ http://backend:5000/
    
    # Allow encoded slashes in URLs to be passed through to backend
    AllowEncodedSlashes On
</VirtualHost>

# modern configuration
SSLProtocol             -all +TLSv1.3
SSLOpenSSLConfCmd       Curves X25519:prime256v1:secp384r1
SSLHonorCipherOrder     off
SSLSessionTickets       off

# NIST 800-53 SC-23: Certificate Revocation Checking via OCSP Stapling
# Enable OCSP stapling to validate certificate authenticity
SSLUseStapling on
SSLStaplingCache "shmcb:logs/stapling-cache(150000)"
SSLStaplingResponderTimeout 5
SSLStaplingReturnResponderErrors off

# Certificate validation depth for chain verification
SSLVerifyDepth 3