<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Local Cloud - Keycloak Authentication</title>
    <!-- NIST 800-53 SC-18: Subresource Integrity for external mobile code -->
    <link rel="stylesheet" 
          href="https://unpkg.com/@picocss/pico@2.0.6/css/pico.min.css"
          integrity="sha384-7P0NVe9LPDbUCAF+fH2R8Egwz1uqNH83Ns/bfJY0fN2XCDBMUI2S9gGzIOIRBKsA"
          crossorigin="anonymous">
    <link rel="stylesheet" href="css/theme.css">
</head>
<body>
    <header class="header">
        <h1>Local Cloud</h1>
        <div class="user-info">
            <span id="who" class="muted"></span>
            <span id="role" class="muted"></span>
            <div id="themeToggleContainer"></div>
        </div>
    </header>

    <main class="container">
        <p class="muted">Secure file storage service with Keycloak authentication. Login to access your files and features based on your role.</p>

        <div class="section">
            <button id="loginBtn" class="btn btn-primary">Login with Keycloak</button>
            <button id="logoutBtn" class="btn" style="display:none">Logout</button>
        </div>

        <div class="muted">
            <small>Authentication is managed by Keycloak. Please use your Keycloak credentials.</small>
        </div>
    </main>

    <!-- Load Keycloak JS adapter -->
    <script id="keycloak-config-loader">
        // Dynamically load Keycloak JS adapter after getting config
        (async function() {
            try {
                const response = await fetch('/api/auth/config');
                const config = await response.json();
                const script = document.createElement('script');
                script.src = config.server_url + '/js/keycloak.js';
                script.onload = function() {
                    console.log('Keycloak JS adapter loaded');
                    initApp();
                };
                script.onerror = function() {
                    console.error('Failed to load Keycloak JS adapter');
                    alert('Failed to load authentication service. Please refresh the page.');
                };
                document.head.appendChild(script);
            } catch(e) {
                console.error('Failed to load Keycloak config:', e);
                alert('Failed to initialize authentication. Please refresh the page.');
            }
        })();
    </script>

    <script src="js/common.js"></script>
    <script>
        async function initApp() {
            const { whoami, redirectToRole, createThemeToggle, initKeycloak, login, logout } = appCommon;

            // Add theme toggle
            document.getElementById('themeToggleContainer').appendChild(createThemeToggle());

            // Initialize Keycloak
            const kc = await initKeycloak();
            
            if (kc && kc.authenticated) {
                // User is authenticated
                document.getElementById('loginBtn').style.display = 'none';
                document.getElementById('logoutBtn').style.display = 'inline-block';
                
                // Get user info and redirect
                const me = await whoami();
                if (me) {
                    document.getElementById('who').textContent = me.username;
                    document.getElementById('role').textContent = '(' + me.role + ')';
                    await redirectToRole(me);
                }
            } else {
                // User not authenticated
                document.getElementById('loginBtn').style.display = 'inline-block';
                document.getElementById('logoutBtn').style.display = 'none';
            }

            // Setup button handlers
            document.getElementById('loginBtn').addEventListener('click', () => {
                login();
            });

            document.getElementById('logoutBtn').addEventListener('click', () => {
                logout();
            });
        }
    </script>
</body>
</html>