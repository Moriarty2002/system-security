<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Moderator - Local Cloud</title>
  <!-- NIST 800-53 SC-18: Subresource Integrity for external mobile code -->
  <link rel="stylesheet" 
        href="https://unpkg.com/@picocss/pico@2.0.6/css/pico.min.css"
        integrity="sha384-+GeIG8KM2IHBaf9XYcoh89b9AJMPJLmhBg+pSI3XKKOvCVvqXJnMwMU8qFRQzFnS"
        crossorigin="anonymous">
  <link rel="stylesheet" href="css/theme.css">
</head>
<body>
  <header class="header">
    <h1>Moderator View</h1>
    <div class="user-info">
      <span id="who" class="muted"></span>
      <div id="themeToggleContainer"></div>
      <button id="logout" class="btn">Logout</button>
    </div>
  </header>

  <main class="container">
    <section class="section">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
        <div>
          <label for="userSelect">View files for:</label>
          <select id="userSelect" class="input"></select>
        </div>
        <div id="unitSelectorContainer">
          <label for="unitSelector" style="margin-right: 0.5rem; font-size: 14px;">Display unit:</label>
        </div>
      </div>
      <div id="usage" class="muted" style="margin-top:8px"></div>
      <div id="breadcrumb" style="margin-top: 5px; font-size: 14px;"></div>
      <table id="filesTable" class="table">
        <thead><tr><th>Name</th><th>Size</th><th>Actions</th></tr></thead>
        <tbody></tbody>
      </table>
    </section>
  </main>

  <script src="js/common.js"></script>
  <script>
    const { headers, whoami, removeToken, downloadBlobResponse, createThemeToggle, formatBytes, createUnitSelector } = appCommon;

    // Add theme toggle
    document.getElementById('themeToggleContainer').appendChild(createThemeToggle());

    // Add unit selector
    document.getElementById('unitSelectorContainer').appendChild(createUnitSelector(() => listFiles()));

    let currentPath = '';

    async function loadUsers(){
      const r = await fetch('/api/admin/users', {headers: headers()});
      if(!r.ok) return;
      const j = await r.json();
      const sel = document.getElementById('userSelect');
      sel.innerHTML = '';
      sel.appendChild(new Option('(select user)', ''));
      j.users.forEach(u => sel.appendChild(new Option(u.username, u.username)));
    }

    async function downloadFile(name, target){
      const params = new URLSearchParams();
      if (target) params.append('user', target);
      if (currentPath) params.append('path', currentPath);
      const url = '/api/files/' + encodeURIComponent(name) + (params.toString() ? '?' + params.toString() : '');
      const res = await fetch(url, { headers: headers() });
      await downloadBlobResponse(res, name);
    }

    function updateBreadcrumb() {
      const breadcrumb = document.getElementById('breadcrumb');
      if (!currentPath) {
        breadcrumb.innerHTML = '<span class="muted">Root</span>';
        return;
      }
      
      const parts = currentPath.split('/');
      let html = '<a href="#" onclick="navigateToPath(\'\')">Root</a>';
      let path = '';
      parts.forEach((part, index) => {
        path += (path ? '/' : '') + part;
        html += ' / <a href="#" onclick="navigateToPath(\'' + path + '\')">' + part + '</a>';
      });
      breadcrumb.innerHTML = html;
    }

    function navigateToPath(path) {
      currentPath = path;
      updateBreadcrumb();
      listFiles();
    }

    // Make navigateToPath globally available for onclick handlers
    window.navigateToPath = navigateToPath;

    async function listFiles(){
      const target = document.getElementById('userSelect').value;
      if(!target) return;

      const url = '/api/files?user=' + encodeURIComponent(target) + 
                  (currentPath ? '&path=' + encodeURIComponent(currentPath) : '');
      const r = await fetch(url, { headers: headers() });
      if(!r.ok) return;
      const j = await r.json();
      const tb = document.querySelector('#filesTable tbody');
      tb.innerHTML = '';

      j.files.forEach(f => {
        const tr = document.createElement('tr');
        let nameDisplay = f.name;
        let actions = '';
        
        if (f.type === 'directory') {
          nameDisplay = 'üìÅ ' + f.name;
          actions = `<button onclick="navigateToPath('${currentPath ? currentPath + '/' + f.name : f.name}')" class="btn btn-secondary">Open</button>`;
        } else {
          actions = `<button data-download="${encodeURIComponent(f.name)}" class="btn">Download</button>`;
        }
        
        tr.innerHTML = `<td>${nameDisplay}</td><td>${f.type === 'directory' ? '-' : formatBytes(f.size)}</td><td>${actions}</td>`;
        tb.appendChild(tr);
      });

      document.getElementById('usage').textContent = `Usage: ${formatBytes(j.usage)} / Quota: ${formatBytes(j.quota)}`;

      // Wire download buttons
      document.querySelectorAll('button[data-download]').forEach(b =>
        b.addEventListener('click', async () => {
          const name = decodeURIComponent(b.getAttribute('data-download'));
          await downloadFile(name, document.getElementById('userSelect').value);
        })
      );
    }

    document.getElementById('userSelect').addEventListener('change', () => {
      currentPath = '';
      updateBreadcrumb();
      listFiles();
    });

    document.getElementById('logout').addEventListener('click', () => {
      removeToken();
      location.href = 'index.html';
    });

    (async function(){
      const me = await whoami();
      if(me) document.getElementById('who').textContent = me.username;

      // Prevent admins from accessing moderator page
      if (me && me.role === 'admin') {
        alert('Access denied: Admins cannot access moderator pages');
        location.href = '/admin.html';
        return;
      }

      await loadUsers();
      updateBreadcrumb();

      // If ?user= is provided, select that user
      const params = new URLSearchParams(window.location.search);
      const pre = params.get('user');
      if (pre) {
        setTimeout(() => {
          const sel = document.getElementById('userSelect');
          for(let i = 0; i < sel.options.length; i++){
            if(sel.options[i].value === pre){
              sel.selectedIndex = i;
              break;
            }
          }
          listFiles();
        }, 200);
      }
    })();
  </script>
</body>
</html>