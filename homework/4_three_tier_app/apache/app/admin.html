<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Admin - Local Cloud</title>
  <!-- NIST 800-53 SC-18: Subresource Integrity for external mobile code -->
  <link rel="stylesheet" 
        href="https://unpkg.com/@picocss/pico@2.0.6/css/pico.min.css"
        integrity="sha384-7P0NVe9LPDbUCAF+fH2R8Egwz1uqNH83Ns/bfJY0fN2XCDBMUI2S9gGzIOIRBKsA"
        crossorigin="anonymous">
  <link rel="stylesheet" href="css/theme.css">
  <link rel="stylesheet" href="css/banner.css">
</head>
<body>
  <header class="header">
    <h1>Admin Panel</h1>
    <div class="user-info">
      <span id="who" class="muted"></span>
      <div id="themeToggleContainer"></div>
      <button id="logout" class="btn">Logout</button>
    </div>
  </header>

  <main class="container">
    <section class="section">
      <h3>Create user</h3>
      <div class="grid">
        <input id="newUser" class="input" placeholder="username">
        <div style="display: flex; gap: 0.5rem;">
          <input id="newQuota" class="input" placeholder="quota" style="flex: 1;">
          <select id="newQuotaUnit" class="input" style="width: auto;">
            <option value="B">B</option>
            <option value="KB">KB</option>
            <option value="MB" selected>MB</option>
            <option value="GB">GB</option>
          </select>
        </div>
        <input id="newPass" class="input" placeholder="password">
      </div>
      <button id="createBtn" class="btn btn-primary">Create</button>
    </section>

    <section class="section">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
        <h3 style="margin: 0;">Users</h3>
        <div id="unitSelectorContainer">
          <label for="unitSelector" style="margin-right: 0.5rem; font-size: 14px;">Display unit:</label>
        </div>
      </div>
      <table id="usersTable" class="table">
        <thead>
          <th>User</th><th>Usage</th><th>Quota</th><th>Actions</th>
        </thead>
        <tbody></tbody>
      </table>
    </section>
  </main>

  <!-- Load Keycloak JS adapter -->
  <script id="keycloak-config-loader">
    // Dynamically load Keycloak JS adapter after getting config
    (async function() {
      try {
        const response = await fetch('/api/auth/config');
        const config = await response.json();
        const script = document.createElement('script');
        script.src = config.server_url + '/js/keycloak.js';
        script.onload = function() {
          console.log('Keycloak JS adapter loaded');
          initApp();
        };
        script.onerror = function() {
          console.error('Failed to load Keycloak JS adapter');
          alert('Failed to load authentication service. Please refresh the page.');
        };
        document.head.appendChild(script);
      } catch(e) {
        console.error('Failed to load Keycloak config:', e);
        alert('Failed to initialize authentication. Please refresh the page.');
      }
    })();
  </script>

  <!-- System Use Notification Banner (AC-8 Compliance) -->
  <script src="js/banner.js"></script>

  <script src="js/common.js"></script>
  <script>
    async function initApp() {
      const { headers, whoami, logout, createThemeToggle, formatBytes, parseBytes, createUnitSelector, initKeycloak } = appCommon;

      // Initialize Keycloak first
      const kc = await initKeycloak();
      if (!kc || !kc.authenticated) {
        alert('You must be logged in to access this page.');
        location.href = '/index.html';
        return;
      }

    // Add theme toggle
    document.getElementById('themeToggleContainer').appendChild(createThemeToggle());

    // Add unit selector
    document.getElementById('unitSelectorContainer').appendChild(createUnitSelector(() => loadUsers()));

    let currentUser = null;

    async function loadUsers() {
      const r = await fetch('/api/admin/users', { headers: headers() });
      if (!r.ok) return;
      const j = await r.json();
      const tb = document.querySelector('#usersTable tbody');
      tb.innerHTML = '';

      j.users.forEach(u => {
        const tr = document.createElement('tr');
        // Prefer a human-friendly username if backend provides it, otherwise fall back to keycloak_id
        const userId = u.keycloak_id || u.username || '';
        const displayName = (u.username && u.username !== 'See Keycloak') ? u.username : userId;

        // Use keycloak_id for server-side operations (backend expects keycloak_id)
        const quotaButton = (u.role === 'admin' || u.role === 'moderator') ? '' : `<button data-user="${userId}" class="btn quota">Set Quota</button>`;
        const deleteButton = (u.role === 'admin' || userId === currentUser?.keycloak_id) ? '' : `<button data-user="${userId}" class="btn btn-danger delete">Delete</button>`;

        tr.innerHTML = `
          <td>${displayName}</td>
          <td>${formatBytes(u.used_quota || 0)}</td>
          <td>${formatBytes(u.quota || 0)}</td>
          <td>
            ${quotaButton}
            ${deleteButton}
          </td>
        `;
        tb.appendChild(tr);
      });

      // Attach event handlers
      document.querySelectorAll('button.quota').forEach(btn => {
        btn.addEventListener('click', async () => {
          const user = btn.getAttribute('data-user');
          const qValue = prompt('New quota value for ' + user + ' (e.g., 100)');
          if (qValue === null) return;
          const qUnit = prompt('Unit for quota (B, KB, MB, GB)', 'MB');
          if (qUnit === null) return;

          const quotaBytes = parseBytes(qValue, qUnit);

          const response = await fetch('/api/admin/users/' + encodeURIComponent(user) + '/quota', {
            method: 'PUT',
            headers: headers(true),
            body: JSON.stringify({ quota: quotaBytes })
          });

          if (!response.ok) {
            const errorData = await response.json().catch(() => ({ error: 'Unknown error' }));
            alert('Failed to set quota: ' + (errorData.error || response.status));
          } else {
            alert('Quota updated successfully');
          }

          await loadUsers();
        });
      });

      // Delete button handlers
      document.querySelectorAll('button.delete').forEach(btn => {
        btn.addEventListener('click', async () => {
          const user = btn.getAttribute('data-user');
          if (!confirm(`Are you sure you want to delete user "${user}"? This action cannot be undone.`)) {
            return;
          }

          const response = await fetch('/api/admin/users/' + encodeURIComponent(user), {
            method: 'DELETE',
            headers: headers()
          });

          if (!response.ok) {
            const errorData = await response.json().catch(() => ({ error: 'Unknown error' }));
            alert('Failed to delete user: ' + (errorData.error || response.status));
          } else {
            alert('User deleted successfully');
            await loadUsers();
          }
        });
      });
    }

    document.getElementById('createBtn').addEventListener('click', async () => {
      const u = document.getElementById('newUser').value.trim();
      const qValue = document.getElementById('newQuota').value || '0';
      const qUnit = document.getElementById('newQuotaUnit').value;
      const q = parseBytes(qValue, qUnit);
      const p = document.getElementById('newPass').value || '';

      if (!u || !p) return alert('username and password required');

      const r = await fetch('/api/admin/users', {
        method: 'POST',
        headers: headers(true),
        body: JSON.stringify({ username: u, quota: q, password: p })
      });

      if (!r.ok) {
        const t = await r.json().catch(() => ({ error: 'fail' }));
        return alert('create failed: ' + (t.error || r.status));
      }

      alert('User created successfully');
      // Clear input fields
      document.getElementById('newUser').value = '';
      document.getElementById('newQuota').value = '';
      document.getElementById('newPass').value = '';

      await loadUsers();
    });

    document.getElementById('logout').addEventListener('click', () => {
      logout();
      logout();
      location.href = 'index.html';
      alert('You have been logged out from MES Local Cloud.');
    });

      // Initialize
      currentUser = await whoami();
      if (currentUser) document.getElementById('who').textContent = currentUser.username;
      await loadUsers();
    }
  </script>
</body>
</html>