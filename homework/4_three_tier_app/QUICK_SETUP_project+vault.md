# Quick Setup Guide - Complete System

Fast setup for Vault infrastructure + 4_three_tier_app project.

## Prerequisites

- Docker & Docker Compose
- jq (JSON processor)

## Setup Steps

### 1. Initialize Vault Infrastructure (First Time Only)

```bash
cd vault-infrastructure

# Start Vault
docker compose up -d

# Initialize Vault (creates vault-keys.json - SAVE THIS FILE!)
cd scripts
./init-vault.sh

# Unseal Vault (if needed)
./unseal-vault.sh

cd ../..
```

**⚠️ CRITICAL**: Save `vault-infrastructure/scripts/vault-keys.json` - contains unseal keys and root token

### 2. Configure Application in Vault

```bash
cd 4_three_tier_app

# Create application secrets and AppRole credentials
cd vault/scripts
./setup-vault-app.sh

cd ../..
```

This generates:
- `.env` file with credentials
- `vault/scripts/approle-credentials.txt`
- `secrets/db_password.txt`
- `be_flask/db_init/001_create_users.sql`

### 3. Setup MinIO Security

```bash
# MinIO credentials are already in .env from step 2
# Just run the init script
./minio/scripts/init-minio.sh
```

Creates:
- `app-storage` user (limited privileges)
- `user-files` bucket
- Least-privilege policy

### 4. Start Application

```bash
# Clean start (removes old data)
docker compose down -v

# Start all services
docker compose up -d

# Wait for services to be ready (~10-15 seconds)
sleep 15
```

### 5. Verify

```bash
# Check all containers are running
docker compose ps

# Check backend connected to Vault
docker compose logs backend | grep -i vault

# Check MinIO is accessible
curl -I http://localhost:9001
```

## Access Points

| Service | URL | Credentials |
|---------|-----|-------------|
| **Application** | https://localhost | admin/admin, alice/alice, moderator/moderator |
| **MinIO Console** | http://localhost:9001 | minioadmin/minioadmin |
| **Vault UI** | https://localhost:8200 | Token from vault-keys.json |

## Quick Restart

```bash
cd 4_three_tier_app

# Restart without losing data
docker compose restart

# Full reset (clears all data)
docker compose down -v
docker compose up -d
```

## Troubleshooting

### Vault is sealed
```bash
cd vault-infrastructure/scripts
./unseal-vault.sh
```

### Need to regenerate secrets
```bash
cd 4_three_tier_app/vault/scripts
./setup-vault-app.sh
cd ../..
docker compose down -v
docker compose up -d
```

### MinIO user needs recreation
```bash
./minio/scripts/init-minio.sh
docker compose restart backend
```

## File Structure

```
vault-infrastructure/
├── scripts/
│   ├── init-vault.sh           # First-time Vault setup
│   ├── unseal-vault.sh         # Unseal if sealed
│   └── vault-keys.json         # ⚠️ KEEP SECURE

4_three_tier_app/
├── .env                        # Generated by setup-vault-app.sh
├── vault/scripts/
│   └── setup-vault-app.sh      # Configure app secrets
├── minio/scripts/
│   └── init-minio.sh           # Setup MinIO security
└── secrets/
    └── db_password.txt         # Generated for Docker
```

## Complete Fresh Setup (One Command)

```bash
# From homework/ directory
cd vault-infrastructure && \
docker compose up -d && sleep 5 && \
cd scripts && ./init-vault.sh && ./unseal-vault.sh && \
cd ../../4_three_tier_app/vault/scripts && ./setup-vault-app.sh && \
cd ../.. && ./minio/scripts/init-minio.sh && \
docker compose down -v && docker compose up -d && \
echo "✅ Setup complete! Access https://localhost"
```

## Security Notes

- ✅ All secrets in Vault (no hardcoded credentials)
- ✅ AppRole authentication (machine-to-machine)
- ✅ MinIO dedicated user (least privilege)
- ✅ Database app user (limited permissions)
- ✅ JWT keys from Vault
- ✅ TLS certificates from Vault PKI

## Next Steps

1. Test login at https://localhost
2. Upload files as alice (user role)
3. Manage users as admin
4. Check Vault audit logs
5. Review MinIO Console for stored files
