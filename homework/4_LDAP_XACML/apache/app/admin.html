<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Admin - Local Cloud</title>
  <link rel="stylesheet" href="https://unpkg.com/@picocss/pico@latest/css/pico.min.css">
  <link rel="stylesheet" href="css/theme.css">
</head>
<body>
  <header class="header">
    <h1>Admin Panel</h1>
    <div class="user-info">
      <span id="who" class="muted"></span>
      <div id="themeToggleContainer"></div>
      <button id="logout" class="btn">Logout</button>
    </div>
  </header>

  <main class="container">
    <section class="section">
      <h3>Create user</h3>
      <div class="grid">
        <input id="newUser" class="input" placeholder="username">
        <input id="newQuota" class="input" placeholder="quota bytes">
        <input id="newPass" class="input" placeholder="password">
      </div>
      <button id="createBtn" class="btn btn-primary">Create</button>
    </section>

    <section class="section">
      <h3>Users</h3>
      <table id="usersTable" class="table">
        <thead>
          <th>User</th><th>Usage</th><th>Quota</th><th>Actions</th>
        </thead>
        <tbody></tbody>
      </table>
    </section>
  </main>

  <script src="js/common.js"></script>
  <script>
    const { headers, whoami, removeToken, createThemeToggle } = appCommon;

    // Add theme toggle
    document.getElementById('themeToggleContainer').appendChild(createThemeToggle());

    async function loadUsers() {
      const r = await fetch('/api/admin/users', { headers: headers() });
      if (!r.ok) return;
      const j = await r.json();
      const tb = document.querySelector('#usersTable tbody');
      tb.innerHTML = '';

      j.users.forEach(u => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${u.username}</td>
          <td>${u.usage}</td>
          <td>${u.quota}</td>
          <td>
            <button data-user="${u.username}" class="btn quota">Set Quota</button>
            <button data-user="${u.username}" class="btn listFiles">List Files</button>
          </td>
        `;
        tb.appendChild(tr);
      });

      // Attach event handlers
      document.querySelectorAll('button.quota').forEach(btn => {
        btn.addEventListener('click', async () => {
          const user = btn.getAttribute('data-user');
          const q = prompt('New quota for ' + user);
          if (q === null) return;

          await fetch('/api/admin/users/' + encodeURIComponent(user) + '/quota', {
            method: 'PUT',
            headers: headers(true),
            body: JSON.stringify({ quota: parseInt(q, 10) })
          });
          await loadUsers();
        });
      });

      document.querySelectorAll('button.listFiles').forEach(btn => {
        btn.addEventListener('click', () => {
          const user = btn.getAttribute('data-user');
          location.href = '/moderator.html?user=' + encodeURIComponent(user);
        });
      });
    }

    document.getElementById('createBtn').addEventListener('click', async () => {
      const u = document.getElementById('newUser').value.trim();
      const q = parseInt(document.getElementById('newQuota').value || '0', 10);
      const p = document.getElementById('newPass').value || '';

      if (!u || !p) return alert('username and password required');

      const r = await fetch('/api/admin/users', {
        method: 'POST',
        headers: headers(true),
        body: JSON.stringify({ username: u, quota: q, password: p })
      });

      if (!r.ok) {
        const t = await r.json().catch(() => ({ error: 'fail' }));
        return alert('create failed: ' + (t.error || r.status));
      }

      await loadUsers();
    });

    document.getElementById('logout').addEventListener('click', () => {
      removeToken();
      location.href = 'index.html';
    });

    // Initialize
    (async function() {
      const me = await whoami();
      if (me) document.getElementById('who').textContent = me.username;
      await loadUsers();
    })();
  </script>
</body>
</html>