<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>User - Local Cloud</title>
  <style>
    body { font-family: system-ui, -apple-system, 'Segoe UI', Roboto, Arial; padding:20px; max-width:800px; margin:auto }
    header { display:flex; gap:12px; align-items:center }
    input, button { padding:6px 8px }
    table { width:100%; border-collapse:collapse; margin-top:12px }
    th, td { padding:8px; border-bottom:1px solid #ddd; text-align:left }
    .muted { color:#666 }
  </style>
</head>
<body>
  <header>
    <h1>Your Files</h1>
    <div style="margin-left:auto">
      <span id="who" class="muted"></span>
      <button id="logout">Logout</button>
    </div>
  </header>

  <section style="margin-top:14px">
    <form id="uploadForm">
      <input type="file" id="fileInput" required>
      <button type="submit">Upload</button>
    </form>
    <div id="usage" class="muted" style="margin-top:8px"></div>
    <table id="filesTable" aria-live="polite">
      <thead><tr><th>Name</th><th>Size</th><th>Actions</th></tr></thead>
      <tbody></tbody>
    </table>
  </section>

  <script src="js/common.js"></script>
  <script>
    const { headers, whoami, removeToken, downloadBlobResponse } = appCommon;

    async function load(){ 
      const me = await whoami(); 
      if(me) document.getElementById('who').textContent = me.username; 
      await listFiles();
    }

    async function downloadFile(name){
      const url = '/api/files/' + encodeURIComponent(name);
      const res = await fetch(url, { headers: headers() });
      await downloadBlobResponse(res, name);
    }

    async function listFiles(){
      const r = await fetch('/api/files', {headers: headers()});
      if(!r.ok) return;
      const j = await r.json();
      const tb = document.querySelector('#filesTable tbody'); 
      tb.innerHTML = '';
      
      j.files.forEach(f => {
        const tr = document.createElement('tr');
        const dlBtn = `<button data-download="${encodeURIComponent(f.name)}">Download</button>`;
        tr.innerHTML = `<td>${f.name}</td><td>${f.size}</td><td>${dlBtn} <button data-name="${f.name}">Delete</button></td>`;
        tb.appendChild(tr);
      });
      
      document.getElementById('usage').textContent = `Usage: ${j.usage} / Quota: ${j.quota}`;
      
      // Wire download buttons
      document.querySelectorAll('button[data-download]').forEach(b => 
        b.addEventListener('click', async () => { 
          const name = decodeURIComponent(b.getAttribute('data-download')); 
          await downloadFile(name); 
        })
      );
      
      // Wire delete buttons
      document.querySelectorAll('button[data-name]').forEach(b => 
        b.addEventListener('click', async () => { 
          const name = b.getAttribute('data-name'); 
          await fetch('/api/files/' + encodeURIComponent(name), {
            method: 'DELETE', 
            headers: headers()
          }); 
          await listFiles();
        })
      );
    }

    document.getElementById('uploadForm').addEventListener('submit', async e => { 
      e.preventDefault(); 
      const file = document.getElementById('fileInput').files[0]; 
      if(!file) return alert('choose a file'); 
      
      const form = new FormData(); 
      form.append('file', file); 
      const r = await fetch('/api/upload', {
        method: 'POST', 
        body: form, 
        headers: headers()
      }); 
      
      if(!r.ok){ 
        const t = await r.json().catch(() => ({error: 'fail'})); 
        return alert('upload failed: ' + (t.error || r.status));
      } 
      await listFiles();
    });

    document.getElementById('logout').addEventListener('click', () => { 
      removeToken(); 
      location.href = 'index.html';
    });

    load();
  </script>
</body>
</html>