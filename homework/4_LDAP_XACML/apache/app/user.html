<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>User - Local Cloud</title>
  <link rel="stylesheet" href="https://unpkg.com/@picocss/pico@latest/css/pico.min.css">
  <link rel="stylesheet" href="css/theme.css">
</head>
<body>
  <header class="header">
    <h1>Your Files</h1>
    <div class="user-info">
      <span id="who" class="muted"></span>
      <div id="themeToggleContainer"></div>
      <button id="logout" class="btn">Logout</button>
    </div>
  </header>

  <main class="container">
    <section class="section">
      <form id="uploadForm">
        <input type="file" id="fileInput" class="input" required>
        <button type="submit" class="btn btn-primary">Upload</button>
      </form>
      <div id="usage" class="muted" style="margin-top:8px"></div>
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
        <h4 style="margin: 0;">Your Files</h4>
        <div id="unitSelectorContainer">
          <label for="unitSelector" style="margin-right: 0.5rem; font-size: 14px;">Display unit:</label>
        </div>
      </div>
      <table id="filesTable" class="table" aria-live="polite">
        <thead><tr><th>Name</th><th>Size</th><th>Actions</th></tr></thead>
        <tbody></tbody>
      </table>
    </section>
  </main>

  <script src="js/common.js"></script>
  <script>
    const { headers, whoami, removeToken, downloadBlobResponse, createThemeToggle, formatBytes, createUnitSelector } = appCommon;

    // Add theme toggle
    document.getElementById('themeToggleContainer').appendChild(createThemeToggle());

    // Add unit selector
    document.getElementById('unitSelectorContainer').appendChild(createUnitSelector(() => listFiles()));

    async function load(){
      const me = await whoami();
      if(me) document.getElementById('who').textContent = me.username;

      // Prevent admins and moderators from accessing user file management page
      if (me && (me.role === 'admin' || me.role === 'moderator')) {
        alert('Access denied: ' + me.role + 's cannot access file management');
        location.href = me.role === 'admin' ? '/admin.html' : '/moderator.html';
        return;
      }

      await listFiles();
    }

    async function downloadFile(name){
      const url = '/api/files/' + encodeURIComponent(name);
      const res = await fetch(url, { headers: headers() });
      await downloadBlobResponse(res, name);
    }

    async function listFiles(){
      const r = await fetch('/api/files', {headers: headers()});
      if(!r.ok) return;
      const j = await r.json();
      const tb = document.querySelector('#filesTable tbody');
      tb.innerHTML = '';

      j.files.forEach(f => {
        const tr = document.createElement('tr');
        const dlBtn = `<button data-download="${encodeURIComponent(f.name)}" class="btn">Download</button>`;
        tr.innerHTML = `<td>${f.name}</td><td>${formatBytes(f.size)}</td><td>${dlBtn} <button data-name="${f.name}" class="btn btn-danger">Delete</button></td>`;
        tb.appendChild(tr);
      });

      document.getElementById('usage').textContent = `Usage: ${formatBytes(j.usage)} / Quota: ${formatBytes(j.quota)}`;

      // Wire download buttons
      document.querySelectorAll('button[data-download]').forEach(b =>
        b.addEventListener('click', async () => {
          const name = decodeURIComponent(b.getAttribute('data-download'));
          await downloadFile(name);
        })
      );

      // Wire delete buttons
      document.querySelectorAll('button[data-name]').forEach(b =>
        b.addEventListener('click', async () => {
          const name = b.getAttribute('data-name');
          if (!confirm(`Are you sure you want to delete "${name}"?`)) return;
          const r = await fetch('/api/files/' + encodeURIComponent(name), {
            method: 'DELETE',
            headers: headers()
          });
          if (!r.ok) {
            const t = await r.json().catch(() => ({error: 'fail'}));
            return alert('delete failed: ' + (t.error || r.status));
          }
          alert('File deleted successfully');
          await listFiles();
        })
      );
    }

    document.getElementById('uploadForm').addEventListener('submit', async e => {
      e.preventDefault();
      const file = document.getElementById('fileInput').files[0];
      if(!file) return alert('choose a file');

      const form = new FormData();
      form.append('file', file);
      const r = await fetch('/api/upload', {
        method: 'POST',
        body: form,
        headers: headers()
      });

      if(!r.ok){
        const t = await r.json().catch(() => ({error: 'fail'}));
        return alert('upload failed: ' + (t.error || r.status));
      }
      alert('File uploaded successfully');
      // Clear file input
      document.getElementById('fileInput').value = '';
      await listFiles();
    });

    document.getElementById('logout').addEventListener('click', () => {
      removeToken();
      location.href = 'index.html';
    });

    load();
  </script>
</body>
</html>