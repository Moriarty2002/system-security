<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Moderator - Local Cloud</title>
  <link rel="stylesheet" href="https://unpkg.com/@picocss/pico@latest/css/pico.min.css">
  <link rel="stylesheet" href="css/theme.css">
</head>
<body>
  <header class="header">
    <h1>Moderator View</h1>
    <div class="user-info">
      <span id="who" class="muted"></span>
      <div id="themeToggleContainer"></div>
      <button id="logout" class="btn">Logout</button>
    </div>
  </header>

  <main class="container">
    <section class="section">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
        <div>
          <label for="userSelect">View files for:</label>
          <select id="userSelect" class="input"></select>
        </div>
        <div id="unitSelectorContainer">
          <label for="unitSelector" style="margin-right: 0.5rem; font-size: 14px;">Display unit:</label>
        </div>
      </div>
      <div id="usage" class="muted" style="margin-top:8px"></div>
      <table id="filesTable" class="table">
        <thead><tr><th>Name</th><th>Size</th><th>Actions</th></tr></thead>
        <tbody></tbody>
      </table>
    </section>
  </main>

  <script src="js/common.js"></script>
  <script>
    const { headers, whoami, removeToken, downloadBlobResponse, createThemeToggle, formatBytes, createUnitSelector } = appCommon;

    // Add theme toggle
    document.getElementById('themeToggleContainer').appendChild(createThemeToggle());

    // Add unit selector
    document.getElementById('unitSelectorContainer').appendChild(createUnitSelector(() => listFiles()));

    async function loadUsers(){
      const r = await fetch('/api/users', {headers: headers()});
      if(!r.ok) return;
      const j = await r.json();
      const sel = document.getElementById('userSelect');
      sel.innerHTML = '';
      sel.appendChild(new Option('(select user)', ''));
      j.users.forEach(u => sel.appendChild(new Option(u, u)));
    }

    async function downloadFile(name, target){
      const url = '/api/files/' + encodeURIComponent(name) +
                  (target ? ('?user=' + encodeURIComponent(target)) : '');
      const res = await fetch(url, { headers: headers() });
      await downloadBlobResponse(res, name);
    }

    async function listFiles(){
      const target = document.getElementById('userSelect').value;
      if(!target) return;

      const r = await fetch('/api/files?user=' + encodeURIComponent(target), {
        headers: headers()
      });
      if(!r.ok) return;
      const j = await r.json();
      const tb = document.querySelector('#filesTable tbody');
      tb.innerHTML = '';

      j.files.forEach(f => {
        const tr = document.createElement('tr');
        const dlBtn = `<button data-download="${encodeURIComponent(f.name)}" class="btn">Download</button>`;
        tr.innerHTML = `<td>${f.name}</td><td>${formatBytes(f.size)}</td><td>${dlBtn}</td>`;
        tb.appendChild(tr);
      });

      document.getElementById('usage').textContent = `Usage: ${formatBytes(j.usage)} / Quota: ${formatBytes(j.quota)}`;

      // Wire download buttons
      document.querySelectorAll('button[data-download]').forEach(b =>
        b.addEventListener('click', async () => {
          const name = decodeURIComponent(b.getAttribute('data-download'));
          await downloadFile(name, document.getElementById('userSelect').value);
        })
      );
    }

    document.getElementById('userSelect').addEventListener('change', listFiles);

    document.getElementById('logout').addEventListener('click', () => {
      removeToken();
      location.href = 'index.html';
    });

    (async function(){
      const me = await whoami();
      if(me) document.getElementById('who').textContent = me.username;
      await loadUsers();

      // If ?user= is provided, select that user
      const params = new URLSearchParams(window.location.search);
      const pre = params.get('user');
      if (pre) {
        setTimeout(() => {
          const sel = document.getElementById('userSelect');
          for(let i = 0; i < sel.options.length; i++){
            if(sel.options[i].value === pre){
              sel.selectedIndex = i;
              break;
            }
          }
          listFiles();
        }, 200);
      }
    })();
  </script>
</body>
</html>