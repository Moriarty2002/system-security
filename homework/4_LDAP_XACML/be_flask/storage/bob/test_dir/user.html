<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>User - Local Cloud</title>
  <link rel="stylesheet" href="https://unpkg.com/@picocss/pico@latest/css/pico.min.css">
  <link rel="stylesheet" href="css/theme.css">
</head>
<body>
  <header class="header">
    <h1>Your Files</h1>
    <div class="user-info">
      <span id="who" class="muted"></span>
      <div id="themeToggleContainer"></div>
      <button id="logout" class="btn">Logout</button>
    </div>
  </header>

  <main class="container">
    <section class="section">
      <form id="uploadForm">
        <input type="file" id="fileInput" class="input" required>
        <input type="text" id="uploadPath" placeholder="Upload to path (optional)" class="input" style="margin-left: 10px; width: 200px;">
        <button type="submit" class="btn btn-primary">Upload</button>
      </form>
      
      <form id="mkdirForm" style="margin-top: 10px;">
        <input type="text" id="dirName" placeholder="New directory name" class="input" required>
        <button type="submit" class="btn btn-secondary">Create Directory</button>
      </form>
      
      <div id="usage" class="muted" style="margin-top:8px"></div>
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
        <div>
          <h4 style="margin: 0;">Your Files</h4>
          <div id="breadcrumb" style="margin-top: 5px; font-size: 14px;"></div>
        </div>
        <div id="unitSelectorContainer">
          <label for="unitSelector" style="margin-right: 0.5rem; font-size: 14px;">Display unit:</label>
        </div>
      </div>
      <table id="filesTable" class="table" aria-live="polite">
        <thead><tr><th>Name</th><th>Size</th><th>Actions</th></tr></thead>
        <tbody></tbody>
      </table>
    </section>
  </main>

  <script src="js/common.js"></script>
  <script>
    const { headers, whoami, removeToken, downloadBlobResponse, createThemeToggle, formatBytes, createUnitSelector } = appCommon;

    // Add theme toggle
    document.getElementById('themeToggleContainer').appendChild(createThemeToggle());

    // Add unit selector
    document.getElementById('unitSelectorContainer').appendChild(createUnitSelector(() => listFiles()));

    let currentPath = '';

    async function load(){
      const me = await whoami();
      if(me) document.getElementById('who').textContent = me.username;

      // Prevent admins and moderators from accessing user file management page
      if (me && (me.role === 'admin' || me.role === 'moderator')) {
        alert('Access denied: ' + me.role + 's cannot access file management');
        location.href = me.role === 'admin' ? '/admin.html' : '/moderator.html';
        return;
      }

      updateBreadcrumb();
      await listFiles();
    }

    async function downloadFile(name){
      const fullPath = currentPath ? currentPath + '/' + name : name;
      const url = '/api/files/' + encodeURIComponent(fullPath);
      const res = await fetch(url, { headers: headers() });
      await downloadBlobResponse(res, name);
    }

    function updateBreadcrumb() {
      const breadcrumb = document.getElementById('breadcrumb');
      if (!currentPath) {
        breadcrumb.innerHTML = '<span class="muted">Root</span>';
        return;
      }
      
      const parts = currentPath.split('/');
      let html = '<a href="#" onclick="navigateToPath(\'\')">Root</a>';
      let path = '';
      parts.forEach((part, index) => {
        path += (path ? '/' : '') + part;
        html += ' / <a href="#" onclick="navigateToPath(\'' + path + '\')">' + part + '</a>';
      });
      breadcrumb.innerHTML = html;
    }

    function navigateToPath(path) {
      currentPath = path;
      updateBreadcrumb();
      listFiles();
    }

    // Make navigateToPath globally available for onclick handlers
    window.navigateToPath = navigateToPath;

    async function listFiles(){
      const url = '/api/files' + (currentPath ? '?path=' + encodeURIComponent(currentPath) : '');
      const r = await fetch(url, {headers: headers()});
      if(!r.ok) return;
      const j = await r.json();
      const tb = document.querySelector('#filesTable tbody');
      tb.innerHTML = '';

      j.files.forEach(f => {
        const tr = document.createElement('tr');
        let nameDisplay = f.name;
        let actions = '';
        
        if (f.type === 'directory') {
          nameDisplay = 'üìÅ ' + f.name;
          actions = `<button onclick="navigateToPath('${currentPath ? currentPath + '/' + f.name : f.name}')" class="btn btn-secondary">Open</button>`;
        } else {
          actions = `<button data-download="${encodeURIComponent(f.name)}" class="btn">Download</button>`;
        }
        
        actions += ` <button data-name="${f.name}" data-type="${f.type}" class="btn btn-danger">Delete</button>`;
        
        tr.innerHTML = `<td>${nameDisplay}</td><td>${f.type === 'directory' ? '-' : formatBytes(f.size)}</td><td>${actions}</td>`;
        tb.appendChild(tr);
      });

      document.getElementById('usage').textContent = `Usage: ${formatBytes(j.usage)} / Quota: ${formatBytes(j.quota)}`;

      // Wire download buttons
      document.querySelectorAll('button[data-download]').forEach(b =>
        b.addEventListener('click', async () => {
          const name = decodeURIComponent(b.getAttribute('data-download'));
          await downloadFile(name);
        })
      );

      // Wire delete buttons
      document.querySelectorAll('button[data-name]').forEach(b =>
        b.addEventListener('click', async () => {
          const name = b.getAttribute('data-name');
          const type = b.getAttribute('data-type');
          const itemType = type === 'directory' ? 'directory' : 'file';
          const fullPath = currentPath ? currentPath + '/' + name : name;
          if (!confirm(`Are you sure you want to delete this ${itemType}: "${name}"?`)) return;
          const r = await fetch('/api/files/' + encodeURIComponent(fullPath), {
            method: 'DELETE',
            headers: headers()
          });
          if (!r.ok) {
            const t = await r.json().catch(() => ({error: 'fail'}));
            return alert(`Delete failed: ${t.error || r.status}`);
          }
          alert(`${itemType.charAt(0).toUpperCase() + itemType.slice(1)} deleted successfully`);
          await listFiles();
        })
      );
    }

    document.getElementById('uploadForm').addEventListener('submit', async e => {
      e.preventDefault();
      const file = document.getElementById('fileInput').files[0];
      if(!file) return alert('choose a file');

      const form = new FormData();
      form.append('file', file);
      const uploadPath = document.getElementById('uploadPath').value.trim();
      if (uploadPath) {
        form.append('path', uploadPath);
      }
      const r = await fetch('/api/upload', {
        method: 'POST',
        body: form,
        headers: headers()
      });

      if(!r.ok){
        const t = await r.json().catch(() => ({error: 'fail'}));
        return alert('upload failed: ' + (t.error || r.status));
      }
      alert('File uploaded successfully');
      // Clear file input
      document.getElementById('fileInput').value = '';
      document.getElementById('uploadPath').value = '';
      await listFiles();
    });

    document.getElementById('mkdirForm').addEventListener('submit', async e => {
      e.preventDefault();
      const dirName = document.getElementById('dirName').value.trim();
      if (!dirName) return alert('Enter a directory name');

      const fullPath = currentPath ? currentPath + '/' + dirName : dirName;
      
      const r = await fetch('/api/mkdir', {
        method: 'POST',
        headers: headers(true),
        body: JSON.stringify({ path: fullPath })
      });

      if(!r.ok){
        const t = await r.json().catch(() => ({error: 'fail'}));
        return alert('Directory creation failed: ' + (t.error || r.status));
      }
      alert('Directory created successfully');
      document.getElementById('dirName').value = '';
      await listFiles();
    });

    document.getElementById('logout').addEventListener('click', () => {
      removeToken();
      location.href = 'index.html';
    });

    load();
  </script>
</body>
</html>